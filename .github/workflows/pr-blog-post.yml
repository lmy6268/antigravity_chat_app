name: PR ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸ ìƒì„±

on:
  pull_request:
    types: [closed]
    branches:
      - develop

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  create-pr-blog:
    name: PR ìš”ì•½ ë¸”ë¡œê·¸ ìƒì„±
    # PRì´ ë¨¸ì§€ë˜ì—ˆì„ ë•Œë§Œ ì‹¤í–‰
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # PRì˜ ëª¨ë“  ì»¤ë°‹ ížˆìŠ¤í† ë¦¬ í•„ìš”

      - name: PR ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        id: pr-info
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_AUTHOR="${{ github.event.pull_request.user.login }}"
          PR_BRANCH="${{ github.event.pull_request.head.ref }}"
          PR_BASE="${{ github.event.pull_request.base.sha }}"
          # ë¨¸ì§€ëœ PRì˜ ê²½ìš° ì›ëž˜ head SHAë¥¼ ì‚¬ìš©í•˜ì—¬ ì»¤ë°‹ ë²”ìœ„ë¥¼ ì •í™•ížˆ ê°€ì ¸ì˜´
          PR_HEAD="${{ github.event.pull_request.head.sha }}"

          echo "number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "title=$PR_TITLE" >> $GITHUB_OUTPUT
          echo "author=$PR_AUTHOR" >> $GITHUB_OUTPUT
          echo "branch=$PR_BRANCH" >> $GITHUB_OUTPUT
          echo "base=$PR_BASE" >> $GITHUB_OUTPUT
          echo "head=$PR_HEAD" >> $GITHUB_OUTPUT

          echo "ðŸ“‹ PR #$PR_NUMBER: $PR_TITLE"
          echo "ðŸ‘¤ ìž‘ì„±ìž: $PR_AUTHOR"
          echo "ðŸŒ¿ ë¸Œëžœì¹˜: $PR_BRANCH"
          echo "ðŸ” ì»¤ë°‹ ë²”ìœ„: $PR_BASE..$PR_HEAD"

      - name: PR ì»¤ë°‹ ë¶„ì„
        id: analyze
        env:
          PR_NUMBER: ${{ steps.pr-info.outputs.number }}
          PR_TITLE: ${{ steps.pr-info.outputs.title }}
          PR_AUTHOR: ${{ steps.pr-info.outputs.author }}
          PR_BRANCH: ${{ steps.pr-info.outputs.branch }}
          PR_BASE: ${{ steps.pr-info.outputs.base }}
          PR_HEAD: ${{ steps.pr-info.outputs.head }}
        run: |
          bash .github/scripts/analyze-pr-commits.sh

      - name: ì»¤ë°‹ ì¡´ìž¬ ì—¬ë¶€ í™•ì¸
        id: check-commits
        run: |
          COMMIT_COUNT=$(jq -r '.summary.total_commits' pr_data.json)
          if [ "$COMMIT_COUNT" -eq 0 ]; then
            echo "has_commits=false" >> $GITHUB_OUTPUT
            echo "ðŸ“­ ì»¤ë°‹ì´ ì—†ì–´ì„œ ë¸”ë¡œê·¸ë¥¼ ìƒì„±í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
          else
            echo "has_commits=true" >> $GITHUB_OUTPUT
            echo "âœ… $COMMIT_COUNT ê°œì˜ ì»¤ë°‹ ë°œê²¬"
          fi

      - name: Gemini CLI ì„¤ì •
        if: steps.check-commits.outputs.has_commits == 'true'
        uses: google-github-actions/run-gemini-cli@v0.1.16
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}

      - name: ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸ ìƒì„±
        if: steps.check-commits.outputs.has_commits == 'true'
        id: generate
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          bash .github/scripts/generate-pr-blog.sh

      - name: GitHub Issueì— ê²Œì‹œ
        if: steps.check-commits.outputs.has_commits == 'true'
        id: post-issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Issue ìƒì„±
          ISSUE_URL=$(gh issue create \
            --title "${{ steps.generate.outputs.title }}" \
            --body-file blog_post.md \
            --label "dev-log,auto-generated,pr-summary")

          echo "issue_url=$ISSUE_URL" >> $GITHUB_OUTPUT
          echo "âœ… Issue ìƒì„± ì™„ë£Œ: $ISSUE_URL"

      - name: PRì— ëŒ“ê¸€ ì¶”ê°€
        if: steps.check-commits.outputs.has_commits == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr comment ${{ steps.pr-info.outputs.number }} --body "ðŸ“ **ê°œë°œ ë¸”ë¡œê·¸ê°€ ìžë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!**

          ðŸ”— [ë¸”ë¡œê·¸ ë³´ê¸°](${{ steps.post-issue.outputs.issue_url }})

          ---
          _ðŸ¤– AIë¡œ ìžë™ ìƒì„±ëœ PR ìš”ì•½ ë¸”ë¡œê·¸_"

      - name: ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        if: always() && steps.check-commits.outputs.has_commits == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: pr-blog-${{ steps.pr-info.outputs.number }}
          path: |
            blog_post.md
            pr_data.json
          retention-days: 90

      - name: ìš”ì•½
        if: always()
        run: |
          if [ "${{ steps.check-commits.outputs.has_commits }}" == "true" ]; then
            echo "## âœ… PR ë¸”ë¡œê·¸ í¬ìŠ¤íŒ… ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **PR**: #${{ steps.pr-info.outputs.number }} - ${{ steps.pr-info.outputs.title }}" >> $GITHUB_STEP_SUMMARY
            echo "- **ìž‘ì„±ìž**: @${{ steps.pr-info.outputs.author }}" >> $GITHUB_STEP_SUMMARY
            echo "- **ë¸Œëžœì¹˜**: \`${{ steps.pr-info.outputs.branch }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- **ì»¤ë°‹ ìˆ˜**: ${{ steps.analyze.outputs.commit_count }}" >> $GITHUB_STEP_SUMMARY
            echo "- **ë³€ê²½ íŒŒì¼**: ${{ steps.analyze.outputs.files_changed }}" >> $GITHUB_STEP_SUMMARY
            echo "- **ë¸”ë¡œê·¸ ì œëª©**: ${{ steps.generate.outputs.title }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "## ðŸ“­ ë¸”ë¡œê·¸ ë¯¸ìƒì„±" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "PRì— ì»¤ë°‹ì´ ì—†ì–´ì„œ ë¸”ë¡œê·¸ ê¸€ì„ ìƒì„±í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
          fi
