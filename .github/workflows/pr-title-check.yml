name: PR 제목 검증

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

jobs:
  check-pr-title:
    runs-on: ubuntu-latest

    steps:
      - name: PR 제목 형식 확인
        uses: actions/github-script@v7
        with:
          script: |
            const prTitle = context.payload.pull_request.title;
            
            // PR 제목 형식: [타입] 제목
            const pattern = /^\[(Feature|Fix|Refactor|Style|Docs|Test|Chore|Perf|Security)\]\s+.+/;
            
            const validTypes = [
              'Feature',
              'Fix', 
              'Refactor',
              'Style',
              'Docs',
              'Test',
              'Chore',
              'Perf',
              'Security'
            ];
            
            if (!pattern.test(prTitle)) {
              const comment = `## ⚠️ PR 제목 형식 오류

현재 PR 제목: \`${prTitle}\`

PR 제목이 올바른 형식을 따르지 않습니다.

**올바른 형식**: [타입] 제목

### 허용된 타입

${validTypes.map(type => `- \`${type}\``).join('\n')}

### 예시

- \`[Feature] 사용자 인증 기능 추가\`
- \`[Fix] 로그인 오류 수정\`
- \`[Refactor] 대시보드 컴포넌트 구조 개선\`

자세한 내용은 [PR 컨벤션 문서](../docs/PR_CONVENTION.md)를 참고해주세요.`;

              // 기존 봇 코멘트 찾기
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
              });

              const botComment = comments.find(comment => 
                comment.user.type === 'Bot' && 
                comment.body.includes('PR 제목 형식 오류')
              );

              if (botComment) {
                // 기존 코멘트 업데이트
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: botComment.id,
                  body: comment
                });
              } else {
                // 새 코멘트 생성
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.payload.pull_request.number,
                  body: comment
                });
              }

              // 경고만 표시 (PR 차단하지 않음)
              core.warning('PR 제목이 형식에 맞지 않습니다.');
              
              // PR을 차단하려면 아래 주석을 해제하세요
              // core.setFailed('PR 제목이 형식에 맞지 않습니다.');
            } else {
              core.info('✅ PR 제목 형식이 올바릅니다.');
              
              // 이전 경고 코멘트가 있다면 삭제
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
              });

              const botComment = comments.find(comment => 
                comment.user.type === 'Bot' && 
                comment.body.includes('PR 제목 형식 오류')
              );

              if (botComment) {
                await github.rest.issues.deleteComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: botComment.id
                });
              }
            }
