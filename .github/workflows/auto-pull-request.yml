name: Auto Pull Request

on:
  push:
    branches:
      - 'feature/**'
      - 'hotfix/**'

env:
  TARGET_BRANCH: develop

jobs:
  ci:
    name: CI & Auto PR
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Enable Corepack
        run: corepack enable

      - name: Install Dependencies
        run: yarn install --immutable

      - name: Run Lint
        id: lint
        # ë¦°íŠ¸ ì—ëŸ¬ê°€ ë‚˜ë„ PR ìƒì„±ì„ ìœ„í•´ ì‘ì—…ì„ ê³„ì†í•¨
        run: |
          yarn lint > lint-results.txt 2>&1 || echo "LINT_FAILED=true" >> $GITHUB_ENV

      - name: Get current branch name
        id: branch
        run: |
          echo "name=${GITHUB_REF#refs/heads/}" >> $GITHUB_OUTPUT

      - name: Check for existing PR
        id: check-pr
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
        run: |
          existing_pr=$(gh pr list --head ${{ steps.branch.outputs.name }} --base ${{ env.TARGET_BRANCH }} --json number,state --jq '.[0]')
          if [ -n "$existing_pr" ] && [ "$existing_pr" != "null" ]; then
            pr_number=$(echo "$existing_pr" | jq -r '.number')
            pr_state=$(echo "$existing_pr" | jq -r '.state')
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "number=$pr_number" >> $GITHUB_OUTPUT
            echo "state=$pr_state" >> $GITHUB_OUTPUT
            echo "âœ… ê¸°ì¡´ PR ë°œê²¬: #$pr_number (ìƒíƒœ: $pr_state)"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "ğŸ“ ìƒˆë¡œìš´ PR ìƒì„± í•„ìš”"
          fi

      - name: Setup Gemini CLI
        if: steps.check-pr.outputs.exists == 'false'
        uses: google-github-actions/run-gemini-cli@v0.1.16
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}

      - name: Generate PR Title and Description
        if: steps.check-pr.outputs.exists == 'false'
        id: generate-pr
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          bash .github/scripts/generate-pr-description.sh \
            ${{ env.TARGET_BRANCH }} \
            ${{ steps.branch.outputs.name }}

      - name: Prepare PR Body with Lint Results
        if: steps.check-pr.outputs.exists == 'false'
        id: prepare-body
        run: |
          BODY="${{ steps.generate-pr.outputs.body }}"
          if [ "$LINT_FAILED" = "true" ]; then
            LINT_LOG=$(cat lint-results.txt | tail -n 50) # ë¡œê·¸ê°€ ë„ˆë¬´ ê¸¸ë©´ í•˜ë‹¨ë§Œ
            BODY="$BODY\n\n---\n\n### ğŸ”´ Lint ì˜¤ë¥˜ ë°œê²¬\n\nCI ê²€ì‚¬ ì¤‘ ë‹¤ìŒ ì˜¤ë¥˜ê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ìŒ ì»¤ë°‹ì—ì„œ ìˆ˜ì •ì„ ê¶Œì¥í•©ë‹ˆë‹¤:\n\n\`\`\`\n$LINT_LOG\n\`\`\`\n"
          else
            BODY="$BODY\n\n---\n\n### âœ… Lint ê²€ì‚¬ í†µê³¼"
          fi

          # ë‹¤ì¤‘ ë¼ì¸ ë³¸ë¬¸ ì²˜ë¦¬ë¥¼ ìœ„í•œ ì¶œë ¥ ì„¤ì •
          echo "final_body<<EOF" >> $GITHUB_OUTPUT
          echo -e "$BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        if: steps.check-pr.outputs.exists == 'false'
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
          TZ: Asia/Seoul
        run: |
          gh pr create \
            --base ${{ env.TARGET_BRANCH }} \
            --head ${{ steps.branch.outputs.name }} \
            --title "${{ steps.generate-pr.outputs.title }}" \
            --body "${{ steps.prepare-body.outputs.final_body }}

          ---
          _ğŸ¤– AIë¡œ ìë™ ìƒì„±ëœ PR_
          _ìƒì„± ì‹œê°„: $(date +'%Y-%m-%d %H:%M:%S KST')_"

      - name: Update existing PR with new commits
        if: steps.check-pr.outputs.exists == 'true' && steps.check-pr.outputs.state == 'OPEN'
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          bash .github/scripts/update-pr-comment.sh \
            ${{ steps.check-pr.outputs.number }} \
            ${{ steps.branch.outputs.name }}
