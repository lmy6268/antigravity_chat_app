name: ìë™ PR ìƒì„±

on:
  push:
    branches-ignore:
      - 'develop'
      - 'main'

env:
  TARGET_BRANCH: develop

jobs:
  ci:
    name: CI ë° ìë™ PR
    runs-on: ubuntu-latest
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Corepack í™œì„±í™”
        run: corepack enable

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: yarn install --immutable

      - name: Lint ì‹¤í–‰
        id: lint
        # ë¦°íŠ¸ ì—ëŸ¬ê°€ ë‚˜ë„ PR ìƒì„±ì„ ìœ„í•´ ì‘ì—…ì„ ê³„ì†í•¨
        run: |
          yarn lint > lint-results.txt 2>&1 || echo "LINT_FAILED=true" >> $GITHUB_ENV

      - name: í˜„ì¬ ë¸Œëœì¹˜ ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
        id: branch
        run: |
          echo "name=${GITHUB_REF#refs/heads/}" >> $GITHUB_OUTPUT

      - name: ê¸°ì¡´ PR í™•ì¸
        id: check-pr
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
        run: |
          existing_pr=$(gh pr list --head ${{ steps.branch.outputs.name }} --base ${{ env.TARGET_BRANCH }} --json number,state --jq '.[0]')
          if [ -n "$existing_pr" ] && [ "$existing_pr" != "null" ]; then
            pr_number=$(echo "$existing_pr" | jq -r '.number')
            pr_state=$(echo "$existing_pr" | jq -r '.state')
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "number=$pr_number" >> $GITHUB_OUTPUT
            echo "state=$pr_state" >> $GITHUB_OUTPUT
            echo "âœ… ê¸°ì¡´ PR ë°œê²¬: #$pr_number (ìƒíƒœ: $pr_state)"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "ğŸ“ ìƒˆë¡œìš´ PR ìƒì„± í•„ìš”"
          fi

      - name: Gemini CLI ì„¤ì •
        if: steps.check-pr.outputs.exists == 'false'
        uses: google-github-actions/run-gemini-cli@v0.1.16
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}

      - name: PR ì œëª© ë° ì„¤ëª… ìƒì„±
        if: steps.check-pr.outputs.exists == 'false'
        id: generate-pr
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          bash .github/scripts/generate-pr-description.sh \
            ${{ env.TARGET_BRANCH }} \
            ${{ steps.branch.outputs.name }}

      - name: Lint ê²°ê³¼ì™€ í•¨ê»˜ PR ë³¸ë¬¸ ì¤€ë¹„
        if: steps.check-pr.outputs.exists == 'false'
        id: prepare-body
        run: |
          # ì„ì‹œ íŒŒì¼ì— ë³¸ë¬¸ ì‘ì„±
          TEMP_BODY=$(mktemp)

          # PR ë³¸ë¬¸ ì¶”ê°€
          echo "${{ steps.generate-pr.outputs.body }}" > "$TEMP_BODY"

          # Lint ê²°ê³¼ ì¶”ê°€
          if [ "$LINT_FAILED" = "true" ]; then
            echo "" >> "$TEMP_BODY"
            echo "---" >> "$TEMP_BODY"
            echo "" >> "$TEMP_BODY"
            echo "### ğŸ”´ Lint ì˜¤ë¥˜ ë°œê²¬" >> "$TEMP_BODY"
            echo "" >> "$TEMP_BODY"
            echo "CI ê²€ì‚¬ ì¤‘ ë‹¤ìŒ ì˜¤ë¥˜ê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ìŒ ì»¤ë°‹ì—ì„œ ìˆ˜ì •ì„ ê¶Œì¥í•©ë‹ˆë‹¤:" >> "$TEMP_BODY"
            echo "" >> "$TEMP_BODY"
            echo '```' >> "$TEMP_BODY"
            cat lint-results.txt | tail -n 50 >> "$TEMP_BODY"
            echo '```' >> "$TEMP_BODY"
          else
            echo "" >> "$TEMP_BODY"
            echo "---" >> "$TEMP_BODY"
            echo "" >> "$TEMP_BODY"
            echo "### âœ… Lint ê²€ì‚¬ í†µê³¼" >> "$TEMP_BODY"
          fi

          # GitHub Outputì— ì €ì¥
          echo "final_body<<EOF" >> $GITHUB_OUTPUT
          cat "$TEMP_BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # ì„ì‹œ íŒŒì¼ ì‚­ì œ
          rm -f "$TEMP_BODY"

      - name: Pull Request ìƒì„±
        if: steps.check-pr.outputs.exists == 'false'
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
          TZ: Asia/Seoul
        run: |
          gh pr create \
            --base ${{ env.TARGET_BRANCH }} \
            --head ${{ steps.branch.outputs.name }} \
            --title "${{ steps.generate-pr.outputs.title }}" \
            --assignee @me \
            --body "${{ steps.prepare-body.outputs.final_body }}

          ---
          _ğŸ¤– AIë¡œ ìë™ ìƒì„±ëœ PR_
          _ìƒì„± ì‹œê°„: $(date +'%Y-%m-%d %H:%M:%S KST')_"

      - name: ê¸°ì¡´ PRì— ìƒˆ ì»¤ë°‹ ìš”ì•½ ì¶”ê°€
        if: steps.check-pr.outputs.exists == 'true' && steps.check-pr.outputs.state == 'OPEN'
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          bash .github/scripts/update-pr-comment.sh \
            ${{ steps.check-pr.outputs.number }} \
            ${{ steps.branch.outputs.name }}
