#!/bin/bash

# Gemini AIë¥¼ ì‚¬ìš©í•˜ì—¬ PR ìš”ì•½ ë¸”ë¡œê·¸ ê¸€ ìƒì„±
# pr_data.jsonì„ ì½ì–´ì„œ ë¸”ë¡œê·¸ ë§ˆí¬ë‹¤ìš´ ìƒì„±

set -e

if [ ! -f "pr_data.json" ]; then
  echo "âŒ pr_data.json íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
  exit 1
fi

# JSON ë°ì´í„° ì½ê¸°
PR_DATA=$(cat pr_data.json)
PR_NUMBER=$(echo "$PR_DATA" | jq -r '.pr_number')
PR_TITLE=$(echo "$PR_DATA" | jq -r '.pr_title')
PR_AUTHOR=$(echo "$PR_DATA" | jq -r '.pr_author')
PR_BRANCH=$(echo "$PR_DATA" | jq -r '.pr_branch')
PR_BODY=$(echo "$PR_DATA" | jq -r '.pr_body')
TOTAL_COMMITS=$(echo "$PR_DATA" | jq -r '.summary.total_commits')
FILES_CHANGED=$(echo "$PR_DATA" | jq -r '.summary.files_changed')
LINES_ADDED=$(echo "$PR_DATA" | jq -r '.summary.lines_added')
LINES_DELETED=$(echo "$PR_DATA" | jq -r '.summary.lines_deleted')

# ì»¤ë°‹ì´ ì—†ìœ¼ë©´ ì¢…ë£Œ
if [ "$TOTAL_COMMITS" -eq 0 ]; then
  echo "ðŸ“­ ì»¤ë°‹ì´ ì—†ì–´ì„œ ë¸”ë¡œê·¸ ê¸€ì„ ìƒì„±í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
  exit 0
fi

echo "ðŸ“ PR #$PR_NUMBER ë¸”ë¡œê·¸ ê¸€ ìƒì„± ì¤‘..."

# ì»¤ë°‹ ëª©ë¡ í¬ë§·íŒ…
COMMIT_LIST=$(echo "$PR_DATA" | jq -r '.commits[] | "- \(.message) (by \(.author))"')

# íŒŒì¼ ëª©ë¡ í¬ë§·íŒ… (ìƒìœ„ 15ê°œ)
FILE_LIST=$(echo "$PR_DATA" | jq -r '.files[]' | head -15)

# íŒŒì¼ë³„ ë³€ê²½ í†µê³„ (ìƒìœ„ 10ê°œ, ë³€ê²½ëŸ‰ ë§Žì€ ìˆœ)
FILE_STATS=$(echo "$PR_DATA" | jq -r '.file_stats | sort_by(.added + .deleted) | reverse | .[:10] | .[] | "- `\(.file)`: +\(.added) -\(.deleted)"')

# í˜„ìž¬ ë‚ ì§œ
CURRENT_DATE=$(date +%Y.%m.%d)

# Gemini AI í”„ë¡¬í”„íŠ¸ ìƒì„±
PROMPT="ë‹¹ì‹ ì€ ìš°ì•„í•œí˜•ì œë“¤ ê¸°ìˆ  ë¸”ë¡œê·¸ ìŠ¤íƒ€ì¼ì˜ ê°œë°œ ë¸”ë¡œê·¸ ìž‘ê°€ìž…ë‹ˆë‹¤.
Pull Requestì˜ ë³€ê²½ì‚¬í•­ì„ ë…ìžë“¤ì´ ì´í•´í•˜ê¸° ì‰½ê²Œ ë¸”ë¡œê·¸ ê¸€ë¡œ ìž‘ì„±í•´ì£¼ì„¸ìš”.

**ìž‘ì„± í˜•ì‹** (ìš°ì•„í•œí˜•ì œë“¤ ê¸°ìˆ  ë¸”ë¡œê·¸ ìŠ¤íƒ€ì¼):

1. **ì œëª©**: '[$CURRENT_DATE] PR #$PR_NUMBER: [í•µì‹¬ ìž‘ì—… ìš”ì•½]' í˜•ì‹
2. **ë©”íƒ€ë°ì´í„°**: ìž‘ì„±ì¼, PR ë²ˆí˜¸, ìž‘ì„±ìž, íƒœê·¸
3. **í”„ë¡¤ë¡œê·¸**: ì´ PRì˜ ë°°ê²½ê³¼ ëª©ì  (2-3 ë¬¸ë‹¨)
4. **ì£¼ìš” ì„¹ì…˜**: ìˆ«ìžë¡œ êµ¬ë¶„ëœ ì„¹ì…˜ (1. 2. 3. ...)
   - ê° ì„¹ì…˜ì€ H2 (##), í•˜ìœ„ ì„¹ì…˜ì€ H3 (###) ì‚¬ìš©
   - ë¬¸ì œ â†’ í•´ê²° â†’ ê²°ê³¼ íë¦„ ìœ ì§€
5. **ë§ºìŒë§**: í•µì‹¬ êµí›ˆê³¼ í–¥í›„ ê³„íš

**ìž‘ì„± ì§€ì¹¨**:

- **ë¬¸ì²´**: ì¹œê·¼í•˜ê³  ì½ê¸° ì‰¬ìš´ ë¬¸ì²´, 1ì¸ì¹­ ë³µìˆ˜í˜• ì‚¬ìš© (\"ì €í¬\", \"ìš°ë¦¬\")
- **êµ¬ì¡°**: í”„ë¡¤ë¡œê·¸ â†’ ë²ˆí˜¸ ë§¤ê¸´ ì„¹ì…˜ â†’ ë§ºìŒë§
- **ê¸°ìˆ  ìš©ì–´**: ì²˜ìŒ ë“±ìž¥ ì‹œ ê°„ë‹¨í•œ ì„¤ëª… ì¶”ê°€
- **ì½”ë“œ ë¸”ë¡**: ì¤‘ìš”í•œ ë³€ê²½ì‚¬í•­ì€ ì½”ë“œë¡œ ì„¤ëª…
- **ì‹œê°ì  ìš”ì†Œ**: í‘œ, ë¦¬ìŠ¤íŠ¸, ì ì ˆí•œ ì´ëª¨ì§€ í™œìš©
- **ìˆ˜ì¹˜ ë°ì´í„°**: êµ¬ì²´ì ì¸ ìˆ˜ì¹˜ë¡œ ì‹ ë¢°ë„ í–¥ìƒ
- **ê¸¸ì´**: 1000ìž ì´ìƒ, ì¶©ë¶„ížˆ ìƒì„¸í•˜ê²Œ ìž‘ì„±

**ì´ëª¨ì§€ ì‚¬ìš© ê°€ì´ë“œ**:
- âœ… ì„±ê³µ/ì™„ë£Œ, âŒ ì‹¤íŒ¨/ë¬¸ì œ, ðŸ“Š í†µê³„, ðŸ” ë¶„ì„, ðŸ’¡ ì•„ì´ë””ì–´, âš ï¸ ì£¼ì˜ì‚¬í•­
- ì œëª©ì—ëŠ” ì‚¬ìš©í•˜ì§€ ì•Šê³ , ë³¸ë¬¸ì—ì„œë§Œ ì ì ˆížˆ í™œìš©

**ì¤‘ìš”**: 
- ì²« ì¤„ì€ ë°˜ë“œì‹œ 'TITLE: [ì œëª©]' í˜•ì‹
- ë‘˜ì§¸ ì¤„ì€ '---' êµ¬ë¶„ì„ 
- ì…‹ì§¸ ì¤„ë¶€í„° ë³¸ë¬¸ ìž‘ì„±

**PR ì •ë³´**:

ðŸ“‹ **PR #$PR_NUMBER: $PR_TITLE**
- ìž‘ì„±ìž: @$PR_AUTHOR
- ë¸Œëžœì¹˜: \`$PR_BRANCH\`

ðŸ“Š **í†µê³„**
- ì´ ì»¤ë°‹ ìˆ˜: $TOTAL_COMMITSê°œ
- ë³€ê²½ëœ íŒŒì¼: $FILES_CHANGEDê°œ
- ì¶”ê°€ëœ ì¤„: $LINES_ADDEDì¤„
- ì‚­ì œëœ ì¤„: $LINES_DELETEDì¤„

**PR ì„¤ëª…**:
$PR_BODY

**ì£¼ìš” ì»¤ë°‹ ë©”ì‹œì§€**:
$COMMIT_LIST

**ë³€ê²½ëœ ì£¼ìš” íŒŒì¼** (ìµœëŒ€ 15ê°œ):
$FILE_LIST

**íŒŒì¼ë³„ ë³€ê²½ í†µê³„** (ìƒìœ„ 10ê°œ):
$FILE_STATS

**í”„ë¡œì íŠ¸ ì •ë³´**:
- í”„ë¡œì íŠ¸ëª…: E2EE WebSocket ì±„íŒ… ì• í”Œë¦¬ì¼€ì´ì…˜
- ê¸°ìˆ  ìŠ¤íƒ: Next.js 16, React 19, TypeScript, Socket.io, Supabase
- ì£¼ìš” ê¸°ëŠ¥: ì¢…ë‹¨ê°„ ì•”í˜¸í™”, ì‹¤ì‹œê°„ ì±„íŒ…

**ìž‘ì„± ì˜ˆì‹œ êµ¬ì¡°**:

\`\`\`markdown
TITLE: $CURRENT_DATE PR #$PR_NUMBER: E2EE ë°© ì´ˆëŒ€ ê¸°ëŠ¥ êµ¬í˜„
---

ìž‘ì„±ì¼: $CURRENT_DATE
PR: #$PR_NUMBER
ìž‘ì„±ìž: @$PR_AUTHOR
íƒœê·¸: E2EE, WebSocket, React

## í”„ë¡¤ë¡œê·¸

ì´ë²ˆ PRì—ì„œëŠ” ì¢…ë‹¨ê°„ ì•”í˜¸í™”(E2EE) ì±„íŒ… ì• í”Œë¦¬ì¼€ì´ì…˜ì— ë°© ì´ˆëŒ€ ê¸°ëŠ¥ì„ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.
ê¸°ì¡´ì—ëŠ” ë°© ìƒì„±ìžê°€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ê³µìœ í•´ì•¼ í–ˆëŠ”ë°, ì´ëŠ” ë³´ì•ˆìƒ ì·¨ì•½ì ì´ ìžˆì—ˆìŠµë‹ˆë‹¤.

## 1. ë¬¸ì œ ì¸ì‹

### 1.1 í˜„ìž¬ ìƒí™©
...

## 2. í•´ê²° ë°©ë²•

### 2.1 ì„¤ê³„
...

## 3. êµ¬í˜„ ê³¼ì •

### 3.1 í•µì‹¬ êµ¬í˜„
...

## 4. ê²°ê³¼

### 4.1 ì •ëŸ‰ì  ì„±ê³¼
- ì»¤ë°‹ ìˆ˜: $TOTAL_COMMITSê°œ
- ë³€ê²½ íŒŒì¼: $FILES_CHANGEDê°œ
- ì½”ë“œ ë³€ê²½: +$LINES_ADDED -$LINES_DELETED

## ë§ºìŒë§

**í•µì‹¬ êµí›ˆ**
- ...
\`\`\`

ì´ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ìš°ì•„í•œí˜•ì œë“¤ ê¸°ìˆ  ë¸”ë¡œê·¸ ìŠ¤íƒ€ì¼ì˜ PR ìš”ì•½ ë¸”ë¡œê·¸ë¥¼ ìž‘ì„±í•´ì£¼ì„¸ìš”.
ë…ìžë“¤ì´ 'ì´ PRì—ì„œ ë¬´ì—‡ì„ í–ˆêµ¬ë‚˜', 'ì–´ë–¤ ê¸°ìˆ ì  ë„ì „ì´ ìžˆì—ˆêµ¬ë‚˜'ë¥¼ ëª…í™•ížˆ ì´í•´í•  ìˆ˜ ìžˆê²Œ ìž‘ì„±í•˜ë˜,
ë„ˆë¬´ ê¸°ìˆ ì ì´ì§€ ì•Šê³  ìŠ¤í† ë¦¬í…”ë§ì´ ìžˆëŠ” ê°œë°œ ì¼ì§€ë¡œ ìž‘ì„±í•´ì£¼ì„¸ìš”.

PR ì œëª©ê³¼ ì„¤ëª…ì„ ì°¸ê³ í•˜ì—¬ ë§¥ë½ì„ íŒŒì•…í•˜ê³ , ì»¤ë°‹ ë©”ì‹œì§€ì™€ ë³€ê²½ëœ íŒŒì¼ì„ ë¶„ì„í•˜ì—¬ 
ì‹¤ì œë¡œ ì–´ë–¤ ìž‘ì—…ì´ ì´ë£¨ì–´ì¡ŒëŠ”ì§€ êµ¬ì²´ì ìœ¼ë¡œ ì„¤ëª…í•´ì£¼ì„¸ìš”."

# Gemini CLIë¡œ ë¸”ë¡œê·¸ ê¸€ ìƒì„± (gemini-2.5-flash ëª¨ë¸ ì‚¬ìš©)
BLOG_CONTENT=$(gemini -m gemini-2.5-flash -p "$PROMPT")

# ì œëª© ì¶”ì¶œ
TITLE=$(echo "$BLOG_CONTENT" | grep "^TITLE:" | sed 's/^TITLE: //')

# ë³¸ë¬¸ ì¶”ì¶œ (TITLEê³¼ --- ì´í›„ ë‚´ìš©)
BODY=$(echo "$BLOG_CONTENT" | sed '1,/^---$/d')

# ë¸”ë¡œê·¸ ê¸€ ì €ìž¥
cat > blog_post.md <<EOF
$BODY

---

**ðŸ“Š PR í†µê³„**

| í•­ëª© | ìˆ˜ì¹˜ |
|------|------|
| PR ë²ˆí˜¸ | #$PR_NUMBER |
| ìž‘ì„±ìž | @$PR_AUTHOR |
| ì»¤ë°‹ ìˆ˜ | $TOTAL_COMMITSê°œ |
| ë³€ê²½ íŒŒì¼ | $FILES_CHANGEDê°œ |
| ì¶”ê°€ëœ ì¤„ | +$LINES_ADDED |
| ì‚­ì œëœ ì¤„ | -$LINES_DELETED |

**ðŸ”— ë§í¬**
- [PR ë³´ê¸°](https://github.com/\${GITHUB_REPOSITORY}/pull/$PR_NUMBER)
EOF

echo "âœ… ë¸”ë¡œê·¸ ê¸€ ìƒì„± ì™„ë£Œ: blog_post.md"
echo "ðŸ“Œ ì œëª©: $TITLE"

# GitHub Actions ì¶œë ¥
if [ -n "$GITHUB_OUTPUT" ]; then
  echo "title=$TITLE" >> "$GITHUB_OUTPUT"
  echo "pr_number=$PR_NUMBER" >> "$GITHUB_OUTPUT"
  echo "body_file=blog_post.md" >> "$GITHUB_OUTPUT"
fi
