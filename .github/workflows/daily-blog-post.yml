name: Daily Dev Blog Post

on:
  push:
    branches:
      - develop  # developì— í‘¸ì‹œë˜ë©´ ë°”ë¡œ ì‹¤í–‰
  schedule:
    # ë§¤ì¼ ìžì • (KST) = UTC 15:00
    - cron: '0 15 * * *'
  workflow_dispatch:
    inputs:
      date:
        description: 'í¬ìŠ¤íŒ…í•  ë‚ ì§œ (YYYY-MM-DD, ê¸°ë³¸ê°’: ì–´ì œ)'
        required: false
        type: string

env:
  BLOG_DATE: ${{ github.event.inputs.date || '' }}

permissions:
  contents: read
  issues: write  # Issue ìƒì„± ê¶Œí•œ

jobs:
  create-and-post-blog:
    name: Generate and Post Daily Blog
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ì „ì²´ ížˆìŠ¤í† ë¦¬ í•„ìš”
      
      - name: Analyze Yesterday's Commits
        id: analyze
        run: |
          bash .github/scripts/analyze-daily-commits.sh
      
      - name: Check if commits exist
        id: check-commits
        run: |
          COMMIT_COUNT=$(jq -r '.summary.total_commits' commits_data.json)
          if [ "$COMMIT_COUNT" -eq 0 ]; then
            echo "has_commits=false" >> $GITHUB_OUTPUT
            echo "ðŸ“­ ì»¤ë°‹ì´ ì—†ì–´ì„œ ë¸”ë¡œê·¸ë¥¼ ìƒì„±í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
          else
            echo "has_commits=true" >> $GITHUB_OUTPUT
            echo "âœ… $COMMIT_COUNT ê°œì˜ ì»¤ë°‹ ë°œê²¬"
          fi
      
      - name: Setup Gemini CLI
        if: steps.check-commits.outputs.has_commits == 'true'
        uses: google-github-actions/run-gemini-cli@v0.1.16
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
      
      - name: Generate Blog Post
        if: steps.check-commits.outputs.has_commits == 'true'
        id: generate
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          bash .github/scripts/generate-blog-post.sh
      
      - name: Post to GitHub Issues
        if: steps.check-commits.outputs.has_commits == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Issue ìƒì„±
          ISSUE_URL=$(gh issue create \
            --title "${{ steps.generate.outputs.title }}" \
            --body-file blog_post.md \
            --label "daily-log,auto-generated,dev-diary")
          
          echo "issue_url=$ISSUE_URL" >> $GITHUB_OUTPUT
          echo "âœ… Issue ìƒì„± ì™„ë£Œ: $ISSUE_URL"
      
      - name: Upload Blog Post Artifact
        if: always() && steps.check-commits.outputs.has_commits == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: blog-post-${{ steps.analyze.outputs.date || github.run_id }}
          path: |
            blog_post.md
            commits_data.json
          retention-days: 30
      
      - name: Summary
        if: always()
        run: |
          if [ "${{ steps.check-commits.outputs.has_commits }}" == "true" ]; then
            echo "## âœ… ë¸”ë¡œê·¸ í¬ìŠ¤íŒ… ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **ì œëª©**: ${{ steps.generate.outputs.title }}" >> $GITHUB_STEP_SUMMARY
            echo "- **ë‚ ì§œ**: ${{ steps.generate.outputs.date }}" >> $GITHUB_STEP_SUMMARY
            echo "- **ì»¤ë°‹ ìˆ˜**: ${{ steps.analyze.outputs.commit_count }}" >> $GITHUB_STEP_SUMMARY
            echo "- **ë³€ê²½ íŒŒì¼**: ${{ steps.analyze.outputs.files_changed }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Issue URL**: [ë°”ë¡œê°€ê¸°](${{ steps.post.outputs.issue_url }})" >> $GITHUB_STEP_SUMMARY
          else
            echo "## ðŸ“­ ë¸”ë¡œê·¸ ë¯¸ìƒì„±" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ì–´ì œ ì»¤ë°‹ì´ ì—†ì–´ì„œ ë¸”ë¡œê·¸ ê¸€ì„ ìƒì„±í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
          fi

